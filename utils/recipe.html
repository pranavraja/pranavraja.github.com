<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Recipe Generator</title>
        <style>
            body {
                white-space: pre-line;
                font-size: 120%;
            }
            details {
                display: inline-block;
                background: #eee;
                vertical-align: middle;
                padding: 0.2em;
                margin: 0.2em;
            }
            details aside {
                float: right;
                margin-top: -1em;
            }
            summary {
                font-weight: bold;
            }
            details details {
                background: #ccc;
            }
            details details details {
                background: darkgray;
            }
            details details details details {
                background: dimgray;
                color: white;
            }
            details details details details details {
                background: darkslategray;
                color: white;
            }
            details details details details details details {
                background: #111;
                color: white;
            }

            body {
                font-family: sans-serif;
                display: flex;
                flex-direction: column;
            }
            textarea {
                width: 100%;
                height: 150px;
                padding: 10px;
                font-family: monospace;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
            button {
                padding: 10px 20px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                align-self: flex-start;
            }
            button:hover {
                background-color: #0056b3;
            }
            #output {
                padding: 10px;
                border: 2px dashed #bbb;
                min-height: 100px;
                background-color: #f9f9f9;
            }
            .label {
                font-weight: bold;
                margin-bottom: 5px;
            }
            .controls {
                display: flex;
                gap: 10px;
            }
            .hidden {
                display: none !important;
            }
            #permalinkBtn {
                background: #28a745;
            }
            #editBtn {
                position: absolute;
                top: 20px;
                right: 20px;
            }
        </style>
    </head>
    <body>
        <div id="editorSection">
            <div>
                <textarea
                    id="userInput"
                    placeholder="Type something here..."
                ></textarea>
            </div>

            <div class="controls">
                <button id="renderBtn">Update preview below</button>
                <button id="permalinkBtn">Copy Permalink</button>
            </div>
        </div>

        <button id="editBtn">Edit Recipe</button>

        <div>
            <div id="output"></div>
        </div>

        <script>
            // --- YOUR CUSTOM FUNCTION ---
            function customHtmlGenerator(inputContent) {
                const paras = inputContent.split("\n\n");
                const sections = [];
                paras.forEach((p) => {
                    const [heading, ...bodyParts] = p.split("\n");
                    const body = bodyParts.join("\n");
                    const s = { body: p };
                    if (heading.match(/^[a-z]/) && heading.endsWith(":")) {
                        s.ingredientName = heading.slice(0, -1);
                        s.body = body;
                        s.duration = body
                            .matchAll(/\b(\d+)min\b/g)
                            .reduce((d, next) => {
                                return d + parseInt(next[1]);
                            }, 0);
                    }
                    sections.push(s);
                });
                for (let i = sections.length - 1; i >= 0; i--) {
                    sections[i].body = sections[i].body.replace(
                        /\[([^\]]+)\]/g,
                        (ingredient) => {
                            ingredient = ingredient.replace(/^\[|\]$/g, "");
                            for (const s of sections) {
                                if (s.ingredientName === ingredient) {
                                    let duration = "";
                                    if (s.duration > 0) {
                                        duration = `<aside>⏰ ${s.duration}min</aside>`;
                                    }
                                    return `<details open><summary>${s.ingredientName}</summary>${duration}${s.body}</details>`;
                                }
                            }
                            return ingredient;
                        },
                    );
                }
                return sections
                    .map((s) => (s.ingredientName ? "" : s.body))
                    .filter((b) => b.replace(/\s/g, "").length > 0)
                    .join("\n\n");
            }

            // --- DOM LOGIC ---
            const btn = document.getElementById("renderBtn");
            const inputArea = document.getElementById("userInput");
            const outputDiv = document.getElementById("output");

            // Logic to render content
            const performRender = () => {
                const rawValue = inputArea.value;
                outputDiv.innerHTML = customHtmlGenerator(rawValue);
            };

            // 1. CLICK: Render
            btn.addEventListener("click", performRender);

            // 1.5. AUTOSAVE: Save to localStorage on input
            inputArea.addEventListener("input", () => {
                localStorage.setItem("recipe-content", inputArea.value);
            });

            // 2. CLICK: Save to URL Fragment
            permalinkBtn.addEventListener("click", async () => {
                const content = inputArea.value;
                // base64 encode to handle special characters and newlines safely
                const encoded = btoa(encodeURIComponent(content));
                window.location.hash = encoded;

                // Generate the full URL
                const fullUrl = window.location.href;

                try {
                    await navigator.clipboard.writeText(fullUrl);

                    // Visual feedback
                    const originalText = permalinkBtn.innerText;
                    permalinkBtn.innerText = "✓ Copied!";
                    permalinkBtn.style.backgroundColor = "#155724";

                    setTimeout(() => {
                        permalinkBtn.innerText = originalText;
                        permalinkBtn.style.backgroundColor = "#28a745";
                    }, 2000);
                } catch (err) {
                    console.error("Failed to copy: ", err);
                    alert(
                        "Updated URL in address bar, but failed to copy automatically.",
                    );
                }
            });
            // Show editor when "Edit" is clicked
            editBtn.addEventListener("click", () => {
                editorSection.classList.remove("hidden");
                editBtn.classList.add("hidden");
            });

            // 3. ON LOAD: Restore from URL Fragment
            window.addEventListener("DOMContentLoaded", () => {
                const hash = window.location.hash.substring(1); // remove the '#'
                if (hash) {
                    try {
                        const decoded = decodeURIComponent(atob(hash));
                        inputArea.value = decoded;
                        performRender(); // Auto-render the restored content

                        // Enter "Viewer Mode"
                        editorSection.classList.add("hidden");
                        editBtn.style.display = "block";
                    } catch (e) {
                        console.error("Failed to parse permalink", e);
                    }
                } else {
                    const saved = localStorage.getItem("recipe-content");
                    if (saved) {
                        inputArea.value = saved;
                        performRender();
                    }
                }
            });
        </script>
    </body>
</html>
