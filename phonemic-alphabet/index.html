<!DOCTYPE html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPA tester</title>
<style>
h1, h3, form, section {
    text-align: center;
}
.correct {
    font-weight: bold;
    color: darkgreen;
}
.wrong {
    font-weight: bold;
    color: darkred;
}
.spell {
    background: navy;
    color: white;
    border: thin solid black;
    padding: 0.5rem;
    margin: 0.5rem;
}
.spell:disabled {
    background: gray;
}

input {
    padding: 0.5rem;
}
</style>
</head>
<body>
<main id="main"></main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mithril/2.0.4/mithril.min.js"></script>
<script>
const root = document.getElementById('main');

function WordGuesser() {
    let showAnswer = false;
    let choice = 0;
    let guessed = '';
    let words = [];
    let total = 0;
    let numCorrect = 0;

    function next(c) {
        location.hash = '';
        choice = c || Math.floor(Math.random()*words.length);
        const g = document.getElementById('guess');
        if (g) {
            g.value = '';
            g.focus();
        }
        showAnswer = false;
        guessed = '';
    }

    function guess(event) {
        event.preventDefault();
        const nextGuess = document.getElementById('guess').value.toLowerCase();
        if (nextGuess == "") return;
        if (guessed != "") return;
        guessed = nextGuess
        const parts = words[choice].split("\t");
        const answers = parts[1].toLowerCase().split(',');
        const correct = answers.filter(a => a == guessed).length;
        if (correct) numCorrect++;
        total++;
        showAnswer = true;
        return false;
    }

    return {
        oninit: function (vnode) {
            words = vnode.attrs.words;
            next(location.hash.slice(1));
        },
        view: function(vnode) {
            const parts = words[choice].split("\t");
            const question = parts[0];
            const answers = parts[1].toLowerCase().split(',');
            const correct = answers.filter(a => a == guessed).length;
            let message = `The correct answer is: `;
            if (answers.length > 1)  {
                message = `The correct answers are: `;
            }
            return m("section", [
                m("h3", `/${question}/`),
                m("form", {onsubmit: guess}, [
                    m("input[type=text][autocomplete=off]#guess"),
                    m("button.spell[type=submit]", { disabled: guessed && "disabled" }, "Spell it")
                ]),
                m("p.score", `Score: ${numCorrect}/${total}`),
                showAnswer ? m("section", [
                    m("p", correct ? `✅` : [
                        m("span", message),
                        m("span.wrong", answers.join(", "))
                    ]),
                    m("button[type=button]", { onclick: () => { next() } }, "Next"),
                    m("p"),
                    m("p", [
                        m("span","Link to this word for your meɪts: "),
                        m("a", { href: `${window.location.protocol}//${window.location.host}${window.location.pathname}#${choice}`}, `${window.location.protocol}//${window.location.host}${window.location.pathname}#${choice}`)
                    ])
                ]) : null,
            ]);
        }
    }
}

function App() {
    let words = null;

    return {
        oninit: function () {
            fetch('ipa1000.txt').then(res => res.text())
                .then(txt => {
                    words = txt.split("\n");
                    m.redraw();
                })
        },
        view: function() {
            return m("article", [
                m("h1", "Spell this word, meɪt"),
                words ?  m(WordGuesser, { words: words }) : m("p", "Loading...")
            ]);
        }
    }
}

m.mount(root, App);
</script>
</body>
